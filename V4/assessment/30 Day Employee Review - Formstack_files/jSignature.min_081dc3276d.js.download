;(function(c){var m="jSignature";var o=function(s,u){var t;this.kick=function(){clearTimeout(t);t=setTimeout(u,s)};this.clear=function(){clearTimeout(t)};return this};var f=function(s){this.topics={};this.context=s?s:this;this.publish=function(x,z,y,u){if(this.topics[x]){var A=this.topics[x],B=Array.prototype.slice.call(arguments,1),D=[],C,w,t,v;for(w=0,t=A.length;w<t;w++){v=A[w];C=v[0];if(v[1]){v[0]=function(){};D.push(w)}C.apply(this.context,B)}for(w=0,t=D.length;w<t;w++){A.splice(D[w],1)}}};this.subscribe=function(t,v,u){if(!this.topics[t]){this.topics[t]=[[v,u]]}else{this.topics[t].push([v,u])}return{topic:t,callback:v}};this.unsubscribe=function(w){if(this.topics[w.topic]){var u=this.topics[w.topic];for(var v=0,t=u.length;v<t;v++){if(u[v][0]===w.callback){u.splice(v,1)}}}}};function h(v){var I,u,C=v.css("color"),s,H=v[0];var J=false;while(H&&!s&&!J){try{I=c(H).css("background-color")}catch(G){I="transparent"}if(I!=="transparent"&&I!=="rgba(0, 0, 0, 0)"){s=I}J=H.body;H=H.parentNode}var E=/rgb[a]*\((\d+),\s*(\d+),\s*(\d+)/,D=/#([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})/,t;I=u;I=C.match(E);if(I){t={r:parseInt(I[1],10),g:parseInt(I[2],10),b:parseInt(I[3],10)}}else{I=C.match(D);if(I){t={r:parseInt(I[1],16),g:parseInt(I[2],16),b:parseInt(I[3],16)}}}var z;if(!s){if(t){if(Math.max.apply(null,[t.r,t.g,t.b])>127){z={r:0,g:0,b:0}}else{z={r:255,g:255,b:255}}}else{z={r:255,g:255,b:255}}}else{I=u;I=s.match(E);if(I){z={r:parseInt(I[1],10),g:parseInt(I[2],10),b:parseInt(I[3],10)}}else{I=s.match(D);if(I){z={r:parseInt(I[1],16),g:parseInt(I[2],16),b:parseInt(I[3],16)}}}}var w=function(K){return"rgb("+[K.r,K.g,K.b].join(", ")+")"},B,F,x;if(t&&z){var y=Math.max.apply(null,[t.r,t.g,t.b]);F=Math.max.apply(null,[z.r,z.g,z.b]);x=Math.round(F+(-1*(F-y)*0.75));B={r:x,g:x,b:x}}else{if(t){F=Math.max.apply(null,[t.r,t.g,t.b]);var A=+1;if(F>127){A=-1}x=Math.round(F+(A*96));B={r:x,g:x,b:x}}else{B={r:191,g:191,b:191}}}return{color:C,"background-color":z?w(z):s,"decor-color":w(B)}}function a(s,u){this.x=s;this.y=u;this.reverse=function(){return new this.constructor(this.x*-1,this.y*-1)};this._length=null;this.getLength=function(){if(!this._length){this._length=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}return this._length};var t=function(v){return Math.round(v/Math.abs(v))};this.resizeTo=function(w){if(this.x===0&&this.y===0){this._length=0}else{if(this.x===0){this._length=w;this.y=w*t(this.y)}else{if(this.y===0){this._length=w;this.x=w*t(this.x)}else{var z=Math.abs(this.y/this.x),v=Math.sqrt(Math.pow(w,2)/(1+Math.pow(z,2))),A=z*v;this._length=w;this.x=v*t(this.x);this.y=A*t(this.y)}}}return this};this.angleTo=function(v){var w=this.getLength()*v.getLength();if(w===0){return 0}else{return Math.acos(Math.min(Math.max((this.x*v.x+this.y*v.y)/w,-1),1))/Math.PI}}}function q(s,t){this.x=s;this.y=t;this.getVectorToCoordinates=function(u,v){return new a(u-this.x,v-this.y)};this.getVectorFromCoordinates=function(u,v){return this.getVectorToCoordinates(u,v).reverse()};this.getVectorToPoint=function(u){return new a(u.x-this.x,u.y-this.y)};this.getVectorFromPoint=function(u){return this.getVectorToPoint(u).reverse()}}function l(s,t,w,B,v){this.data=s;this.context=t;if(s.length){var y=s.length,A,z;for(var x=0;x<y;x++){A=s[x];z=A.x.length;w.call(t,A);for(var u=1;u<z;u++){B.call(t,A,u)}v.call(t,A)}}this.changed=function(){};this.startStrokeFn=w;this.addToStrokeFn=B;this.endStrokeFn=v;this.inStroke=false;this._lastPoint=null;this._stroke=null;this.startStroke=function(C){if(C&&typeof(C.x)=="number"&&typeof(C.y)=="number"){this._stroke={x:[C.x],y:[C.y]};this.data.push(this._stroke);this._lastPoint=C;this.inStroke=true;var F=this._stroke,E=this.startStrokeFn,D=this.context;setTimeout(function(){E.call(D,F)},3);return C}else{return null}};this.addToStroke=function(D){if(this.inStroke&&typeof(D.x)==="number"&&typeof(D.y)==="number"&&(Math.abs(D.x-this._lastPoint.x)+Math.abs(D.y-this._lastPoint.y))>4){var C=this._stroke.x.length;this._stroke.x.push(D.x);this._stroke.y.push(D.y);this._lastPoint=D;var G=this._stroke,F=this.addToStrokeFn,E=this.context;setTimeout(function(){F.call(E,G,C)},3);return D}else{return null}};this.endStroke=function(){var G=this.inStroke;this.inStroke=false;this._lastPoint=null;if(G){var F=this._stroke,E=this.endStrokeFn,D=this.context,C=this.changed;setTimeout(function(){E.call(D,F);C.call(D)},3);return true}else{return null}}}var d=function(t,s,w,v){var u=t.fillStyle;t.fillStyle=t.strokeStyle;t.fillRect(s+v/-2,w+v/-2,v,v);t.fillStyle=u},e=function(t,u,s,w,v){t.beginPath();t.moveTo(u,s);t.lineTo(w,v);t.stroke()},g=function(A,t,s,x,w,v,u,z,y){A.beginPath();A.moveTo(t,s);A.bezierCurveTo(v,u,z,y,x,w);A.stroke()},k=function(s){d(this.canvasContext,s.x[0],s.y[0],this.settings.lineWidth)},j=function(F,D){var t=new q(F.x[D-1],F.y[D-1]),y=new q(F.x[D],F.y[D]),u=t.getVectorToPoint(y);if(D>1){var E=new q(F.x[D-2],F.y[D-2]),A=E.getVectorToPoint(t),w;if(A.getLength()>this.lineCurveThreshold){if(D>2){w=(new q(F.x[D-3],F.y[D-3])).getVectorToPoint(E)}else{w=new a(0,0)}var s=0.05,v=A.getLength()*0.35,C=A.angleTo(w.reverse()),B=u.angleTo(A.reverse()),z=new a(w.x+A.x,w.y+A.y).resizeTo(Math.max(s,C)*v),x=(new a(A.x+u.x,A.y+u.y)).reverse().resizeTo(Math.max(s,B)*v);g(this.canvasContext,E.x,E.y,t.x,t.y,E.x+z.x,E.y+z.y,t.x+x.x,t.y+x.y)}}if(u.getLength()<=this.lineCurveThreshold){e(this.canvasContext,t.x,t.y,y.x,y.y)}},b=function(w){var u=w.x.length-1;if(u>0){var y=new q(w.x[u],w.y[u]),t=new q(w.x[u-1],w.y[u-1]),s=t.getVectorToPoint(y),x;if(s.getLength()>this.lineCurveThreshold){if(u>1){x=(new q(w.x[u-2],w.y[u-2])).getVectorToPoint(t);var v=new a(x.x+s.x,x.y+s.y).resizeTo(s.getLength()/2);g(this.canvasContext,t.x,t.y,y.x,y.y,t.x+v.x,t.y+v.y,y.x,y.y)}else{e(this.canvasContext,t.x,t.y,y.x,y.y)}}}};function n(t,v,u,s){if(v==="ratio"||v.split("")[v.length-1]==="%"){this.eventTokens[u+".parentresized"]=s.subscribe(u+".parentresized",(function(z,y,w,x){return function(){var A=y.width();if(A!==w){for(var B in z){if(z.hasOwnProperty(B)){s.unsubscribe(z[B]);delete z[B]}}var C=t.settings;t.$parent.children().remove();for(var B in t){if(t.hasOwnProperty(B)){delete t[B]}}C.data=(function(I,F){var L=[];var D,J,G,H,E,K;for(J=0,G=I.length;J<G;J++){K=I[J];D={x:[],y:[]};for(H=0,E=K.x.length;H<E;H++){D.x.push(K.x[H]*F);D.y.push(K.y[H]*F)}L.push(D)}return L})(C.data,A*1/w);y[u](C)}}})(this.eventTokens,this.$parent,this.$parent.width(),this.canvas.width*1/this.canvas.height))}}function r(A,D,x){var w=this.$parent=c(A),B=this.eventTokens={},C=this.events=new f(this),u=c.fn[m]("globalEvents"),v={width:"ratio",height:"ratio",sizeRatio:4,color:"#000","background-color":"#fff","decor-color":"#eee",lineWidth:0,minFatFingerCompensation:-10,showUndoButton:false,data:[]};c.extend(v,h(w));if(D){c.extend(v,D)}this.settings=v;for(var z in x){if(x.hasOwnProperty(z)){x[z].call(this,z)}}this.events.publish(m+".initializing");this.$controlbarUpper=(function(){var E="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1em !important;margin-bottom:1em !important;";return c('<div style="'+E+'"></div>').appendTo(w)})();this.isCanvasEmulator=false;var t=this.canvas=this.initializeCanvas(v),y=c(t);this.$controlbarLower=(function(){var E="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1.5em !important;margin-bottom:1.5em !important;";return c('<div style="'+E+'"></div>').appendTo(w)})();this.canvasContext=t.getContext("2d");y.data(m+".this",this);v.lineWidth=(function(F,E){if(!F){return Math.max(Math.round(E/400),2)}else{return F}})(v.lineWidth,t.width);this.lineCurveThreshold=v.lineWidth*3;if(v.cssclass&&c.trim(v.cssclass)!=""){y.addClass(v.cssclass)}this.fatFingerCompensation=0;var s=(function(F){var I,H,E=function(){var K=c(F.canvas).offset();I=K.left*-1;H=K.top*-1},G=function(L){var K=(L.changedTouches&&L.changedTouches.length>0?L.changedTouches[0]:L);return new q(Math.round(K.pageX+I),Math.round(K.pageY+H)+F.fatFingerCompensation)},J=new o(750,function(){F.dataEngine.endStroke()});this.drawEndHandler=function(L){try{L.preventDefault()}catch(K){}J.clear();F.dataEngine.endStroke()};this.drawStartHandler=function(K){K.preventDefault();E();F.dataEngine.startStroke(G(K));J.kick()};this.drawMoveHandler=function(K){K.preventDefault();if(!F.dataEngine.inStroke){return}F.dataEngine.addToStroke(G(K));J.kick()};return this}).call({},this);(function(J,H,F){var E=this.canvas,I=c(E),G;if(this.isCanvasEmulator){I.bind("mousemove."+m,F);I.bind("mouseup."+m,J);I.bind("mousedown."+m,H)}else{E.ontouchstart=function(K){E.onmousedown=G;E.onmouseup=G;E.onmousemove=G;this.fatFingerCompensation=(v.minFatFingerCompensation&&v.lineWidth*-3>v.minFatFingerCompensation)?v.lineWidth*-3:v.minFatFingerCompensation;H(K);E.ontouchend=J;E.ontouchstart=H;E.ontouchmove=F};E.onmousedown=function(K){E.ontouchstart=G;E.ontouchend=G;E.ontouchmove=G;H(K);E.onmousedown=H;E.onmouseup=J;E.onmousemove=F}}}).call(this,s.drawEndHandler,s.drawStartHandler,s.drawMoveHandler);B[m+".windowmouseup"]=u.subscribe(m+".windowmouseup",s.drawEndHandler);this.events.publish(m+".attachingEventHandlers");n.call(this,this,v.width.toString(10),m,u);this.resetCanvas(v.data);this.events.publish(m+".initialized");return this}r.prototype.resetCanvas=function(y){var u=this.canvas,w=this.settings,A=this.canvasContext,t=this.isCanvasEmulator,x=u.width,s=u.height;A.clearRect(0,0,x+30,s+30);A.shadowColor=A.fillStyle=w["background-color"];if(t){A.fillRect(0,0,x+30,s+30)}A.lineWidth=Math.ceil(parseInt(w.lineWidth,10));A.lineCap=A.lineJoin="round";A.strokeStyle=w["decor-color"];A.shadowOffsetX=0;A.shadowOffsetY=0;var v=Math.round(s/5);e(A,v*1.5,s-v,x-(v*1.5),s-v);A.strokeStyle=w.color;if(!t){A.shadowColor=A.strokeStyle;A.shadowOffsetX=A.lineWidth*0.5;A.shadowOffsetY=A.lineWidth*-0.6;A.shadowBlur=0}if(!y){y=[]}var z=this.dataEngine=new l(y,this,k,j,b);w.data=y;c(u).data(m+".data",y).data(m+".settings",w);z.changed=(function(D,B,C){return function(){B.publish(C+".change");D.trigger("change")}})(this.$parent,this.events,m);if(c.support.leadingWhitespace){z.changed()}return true};function p(s){if(s.getContext){return false}else{var w=s.ownerDocument.parentWindow;var v=w.FlashCanvas?s.ownerDocument.parentWindow.FlashCanvas:(typeof FlashCanvas==="undefined"?undefined:FlashCanvas);if(v){s=v.initElement(s);var u=1;if(w&&w.screen&&w.screen.deviceXDPI&&w.screen.logicalXDPI){u=w.screen.deviceXDPI*1/w.screen.logicalXDPI}if(u!==1){try{c(s).children("object").get(0).resize(Math.ceil(s.width*u),Math.ceil(s.height*u));s.getContext("2d").scale(u,u)}catch(t){}}return true}else{throw new Error("Canvas element does not support 2d context. jSignature cannot proceed.")}}}r.prototype.initializeCanvas=function(t){var s=document.createElement("canvas"),u=c(s);if(t.width===t.height&&t.height==="ratio"){t.width="100%"}u.css("margin",0).css("padding",0).css("border","none").css("height",t.height==="ratio"||!t.height?1:t.height.toString(10)).css("width",t.width==="ratio"||!t.width?1:t.width.toString(10));u.appendTo(this.$parent);if(t.height==="ratio"){u.css("height",Math.round(u.width()/t.sizeRatio))}else{if(t.width==="ratio"){u.css("width",Math.round(u.height()*t.sizeRatio))}}u.addClass(m);s.width=u.width();s.height=u.height();this.isCanvasEmulator=p(s);s.onselectstart=function(v){if(v&&v.preventDefault){v.preventDefault()}if(v&&v.stopPropagation){v.stopPropagation()}return false};return s};var i=function(C){var t=new f();(function(D,H,I,G){var E,F=function(){D.publish(H+".parentresized")};I(G).bind("resize."+H,function(){if(E){clearTimeout(E)}E=setTimeout(F,500)}).bind("mouseup."+H,function(J){D.publish(H+".windowmouseup")})})(t,m,c,C);var z={};var s={"default":function(D){return this.toDataURL()},"native":function(D){return D},image:function(F){var E=this.toDataURL();if(typeof E==="string"&&E.length>4&&E.slice(0,5)==="data:"&&E.indexOf(",")!==-1){var D=E.indexOf(",");return[E.slice(5,D),E.substr(D+1)]}return[]}};function B(F,H,E){var D=new Image(),G=this;D.onload=function(){var I=G.getContext("2d").drawImage(D,0,0,(D.width<G.width)?D.width:G.width,(D.height<G.height)?D.height:G.height)};D.src="data:"+H+","+F}var u={"native":function(E,F,D){D(E)},image:B,"image/png;base64":B,"image/jpeg;base64":B,"image/jpg;base64":B};function x(D){this.find("canvas."+m).add(this.filter("canvas."+m)).data(m+".this").resetCanvas(D);return this}function A(F,G){var D;if(G===D&&typeof F==="string"&&F.substr(0,5)==="data:"){G=F.slice(5).split(",")[0];F=F.slice(6+G.length);if(G===F){return}}var E=this.find("canvas."+m).add(this.filter("canvas."+m));if(!u.hasOwnProperty(G)){throw new Error(m+" is unable to find import plugin with for format '"+String(G)+"'")}else{if(E.length!==0){u[G].call(E[0],F,G,(function(H){return function(){return H.resetCanvas.apply(H,arguments)}})(E.data(m+".this")))}}return this}var y=function(E){var D=false;E=E.parentNode;while(E&&!D){D=E.body;E=E.parentNode}return !D};var w={"export":s,"import":u,instance:z},v={init:function(D){return this.each(function(){if(!y(this)){new r(this,D,z)}})},getSettings:function(){return this.find("canvas."+m).add(this.filter("canvas."+m)).data(m+".this").settings},clear:x,reset:x,addPlugin:function(F,E,D){if(w.hasOwnProperty(F)){w[F][E]=D}return this},listPlugins:function(G){var E=[];if(w.hasOwnProperty(G)){var F=w[G];for(var D in F){if(F.hasOwnProperty(D)){E.push(D)}}}return E},getData:function(F){var D,E=this.find("canvas."+m).add(this.filter("canvas."+m));if(F===D){F="default"}if(E.length!==0&&s.hasOwnProperty(F)){return s[F].call(E.get(0),E.data(m+".data"))}},importData:A,setData:A,globalEvents:function(){return t},events:function(){return this.find("canvas."+m).add(this.filter("canvas."+m)).data(m+".this").events}};c.fn[m]=function(D){if(!D||typeof D==="object"){return v.init.apply(this,arguments)}else{if(typeof D==="string"&&v[D]){return v[D].apply(this,Array.prototype.slice.call(arguments,1))}else{c.error("Method "+String(D)+" does not exist on jQuery."+m)}}}};i(window)})(jQuery);
